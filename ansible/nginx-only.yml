---
- name: Quick nginx configuration update
  hosts: pi
  become: true
  gather_facts: true

  tasks:
    - name: Ensure nginx config dir
      ansible.builtin.file:
        path: "/etc/nginx/conf.d"
        state: directory
        mode: '0755'

    - name: Template nginx site
      ansible.builtin.template:
        src: "templates/nginx/site.conf.j2"
        dest: "/etc/nginx/conf.d/default.conf"
        mode: '0644'
      notify: restart reverse proxy

    - name: Test nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Reload nginx if config is valid
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
      when: nginx_test.rc == 0

  handlers:
    - name: restart reverse proxy
      community.docker.docker_compose_v2:
        project_src: "/home/{{ ansible_user }}"
        files:
          - compose/docker-compose.yml
        services:
          - nginx
        restarted: true